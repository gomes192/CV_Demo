{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/samue/OneDrive/Documents/Code/Projetos%20de%20Sites/CV_Demo/components/PeopleCounter.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useRef, useState } from \"react\";\nimport * as cocoSsd from \"@tensorflow-models/coco-ssd\";\nimport \"@tensorflow/tfjs\";\n\ntype DetectionStatus = \"idle\" | \"loading\" | \"running\" | \"error\";\n\nexport function PeopleCounter() {\n  const videoRef = useRef<HTMLVideoElement | null>(null);\n  const canvasRef = useRef<HTMLCanvasElement | null>(null);\n  const historyRef = useRef<{ count: number; t: number }[]>([]);\n  const lastEstimateUpdateRef = useRef<number>(0);\n  const maxEstimatedCountRef = useRef<number>(0);\n  const lastMaxIncreaseRef = useRef<number>(0);\n  const SWEEP_RESET_MS = 45_000;\n  const [status, setStatus] = useState<DetectionStatus>(\"idle\");\n  const [error, setError] = useState<string | null>(null);\n  const [peopleCount, setPeopleCount] = useState<number>(0);\n  const [estimatedCount, setEstimatedCount] = useState<number>(0);\n  const [maxEstimatedCount, setMaxEstimatedCount] = useState<number>(0);\n  const [faceMode, setFaceMode] = useState<\"user\" | \"environment\">(\n    \"environment\",\n  );\n\n  useEffect(() => {\n    let model: cocoSsd.ObjectDetection | null = null;\n    let animationFrameId: number | null = null;\n    let isCancelled = false;\n\n    async function setupCamera() {\n      try {\n        setStatus(\"loading\");\n\n        const video = videoRef.current;\n        const canvas = canvasRef.current;\n        if (!video || !canvas) return;\n\n        const stream = await navigator.mediaDevices.getUserMedia({\n          video: {\n            facingMode: { ideal: faceMode },\n            width: { ideal: 1280 },\n            height: { ideal: 720 },\n          },\n          audio: false,\n        });\n\n        video.srcObject = stream;\n        await video.play();\n\n        canvas.width = video.videoWidth;\n        canvas.height = video.videoHeight;\n\n        model = await cocoSsd.load({ base: \"lite_mobilenet_v2\" });\n\n        if (isCancelled) {\n          stream.getTracks().forEach((t) => t.stop());\n          return;\n        }\n\n        setStatus(\"running\");\n\n        const ctx = canvas.getContext(\"2d\");\n        if (!ctx) return;\n\n        const detectFrame = async () => {\n          if (!video || !model || video.readyState !== 4) {\n            animationFrameId = requestAnimationFrame(detectFrame);\n            return;\n          }\n\n          try {\n            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);\n\n            const predictions = await model.detect(canvas, 40, 0.35);\n            const persons = predictions.filter(\n              (p) => p.class === \"person\" && p.score !== undefined && p.score >= 0.4,\n            );\n            const currentCount = persons.length;\n            setPeopleCount(currentCount);\n\n            const now = performance.now();\n            const windowMs = 10_000;\n            const history = historyRef.current;\n            history.push({ count: currentCount, t: now });\n            while (history.length && now - history[0].t > windowMs) {\n              history.shift();\n            }\n\n            if (now - lastEstimateUpdateRef.current > 400) {\n              lastEstimateUpdateRef.current = now;\n              let median: number;\n              if (history.length) {\n                const counts = history.map((h) => h.count).sort((a, b) => a - b);\n                const mid = Math.floor(counts.length / 2);\n                median =\n                  counts.length % 2 === 0\n                    ? Math.round((counts[mid - 1] + counts[mid]) / 2)\n                    : counts[mid];\n              } else {\n                median = currentCount;\n              }\n              setEstimatedCount(median);\n\n              const maxRef = maxEstimatedCountRef.current;\n              const lastMax = lastMaxIncreaseRef.current;\n              if (median > maxRef) {\n                maxEstimatedCountRef.current = median;\n                lastMaxIncreaseRef.current = now;\n                setMaxEstimatedCount(median);\n              } else if (now - lastMax > SWEEP_RESET_MS) {\n                maxEstimatedCountRef.current = median;\n                lastMaxIncreaseRef.current = now;\n                setMaxEstimatedCount(median);\n              }\n            }\n\n            ctx.lineWidth = 2;\n            ctx.font = \"14px system-ui, -apple-system, BlinkMacSystemFont, sans-serif\";\n\n            persons.forEach((person) => {\n              const [x, y, width, height] = person.bbox;\n              ctx.strokeStyle = \"#22c55e\";\n              ctx.fillStyle = \"rgba(34, 197, 94, 0.15)\";\n              ctx.fillRect(x, y, width, height);\n              ctx.strokeRect(x, y, width, height);\n\n              const label = `${(person.score ?? 0 * 100).toFixed(0)}% pessoa`;\n              const labelX = x;\n              const labelY = y > 20 ? y - 6 : y + 18;\n\n              ctx.fillStyle = \"rgba(15, 23, 42, 0.9)\";\n              ctx.fillRect(labelX, labelY - 16, ctx.measureText(label).width + 10, 18);\n\n              ctx.fillStyle = \"#e5e7eb\";\n              ctx.fillText(label, labelX + 5, labelY - 3);\n            });\n          } catch (err) {\n            console.error(err);\n          }\n\n          animationFrameId = requestAnimationFrame(detectFrame);\n        };\n\n        detectFrame();\n      } catch (err) {\n        console.error(err);\n        setStatus(\"error\");\n        setError(\n          err instanceof Error\n            ? err.message\n            : \"Falha ao iniciar câmera ou detecção.\",\n        );\n      }\n    }\n\n    setupCamera();\n\n    return () => {\n      isCancelled = true;\n\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n      }\n\n      const video = videoRef.current;\n      if (video && video.srcObject instanceof MediaStream) {\n        video.srcObject.getTracks().forEach((t) => t.stop());\n      }\n    };\n  }, [faceMode]);\n\n  const statusLabel =\n    status === \"idle\"\n      ? \"Inativo\"\n      : status === \"loading\"\n        ? \"Carregando…\"\n        : status === \"running\"\n          ? \"Ao vivo\"\n          : \"Erro\";\n\n  const peopleLabel = estimatedCount === 1 ? \"pessoa\" : \"pessoas\";\n\n  return (\n    <div className=\"flex h-full min-h-0 flex-1 flex-row gap-0\">\n      {/* Câmera ocupa a maior parte da tela */}\n      <div className=\"relative min-w-0 flex-1 overflow-hidden bg-slate-900\">\n        <video\n          ref={videoRef}\n          className=\"pointer-events-none absolute inset-0 h-full w-full object-cover opacity-0\"\n          playsInline\n          muted\n        />\n        <canvas\n          ref={canvasRef}\n          className=\"h-full w-full bg-slate-900 object-cover\"\n        />\n      </div>\n\n      {/* Painel do contador ao lado */}\n      <aside className=\"flex w-28 flex-shrink-0 flex-col justify-between border-l border-slate-800/80 bg-slate-950/90 p-3 backdrop-blur sm:w-36 md:w-44 md:p-4\">\n        <div className=\"flex flex-col gap-3\">\n          <div className=\"flex items-center justify-between gap-2\">\n            <span\n              className={`h-2 w-2 flex-shrink-0 rounded-full ${\n                status === \"running\"\n                  ? \"bg-emerald-400\"\n                  : status === \"loading\"\n                    ? \"bg-amber-400 animate-pulse\"\n                    : status === \"error\"\n                      ? \"bg-rose-400\"\n                      : \"bg-slate-500\"\n              }`}\n              title={statusLabel}\n            />\n            <span className=\"truncate text-[0.65rem] font-medium uppercase tracking-wider text-slate-500\">\n              {statusLabel}\n            </span>\n          </div>\n\n          <div>\n            <p className=\"text-[0.6rem] font-medium uppercase tracking-widest text-slate-500 md:text-[0.65rem]\">\n              Estimativa\n            </p>\n            <p className=\"mt-0.5 text-3xl font-semibold tabular-nums text-emerald-400 sm:text-4xl md:text-5xl\">\n              {estimatedCount}\n            </p>\n            <p className=\"text-[0.65rem] text-slate-400\">{peopleLabel}</p>\n          </div>\n\n          <div className=\"border-t border-slate-800/80 pt-2\">\n            <p className=\"text-[0.55rem] uppercase tracking-wider text-slate-500 md:text-[0.6rem]\">\n              Máx. varredura\n            </p>\n            <p className=\"mt-0.5 text-xl font-medium tabular-nums text-slate-300 md:text-2xl\">\n              {maxEstimatedCount}\n            </p>\n          </div>\n\n          <div className=\"border-t border-slate-800/80 pt-2\">\n            <p className=\"text-[0.55rem] uppercase tracking-wider text-slate-500 md:text-[0.6rem]\">\n              Frame atual\n            </p>\n            <p className=\"mt-0.5 text-lg font-medium tabular-nums text-slate-400 md:text-xl\">\n              {peopleCount}\n            </p>\n          </div>\n        </div>\n\n        <div className=\"mt-auto pt-3\">\n          <button\n            type=\"button\"\n            onClick={() =>\n              setFaceMode((prev) =>\n                prev === \"environment\" ? \"user\" : \"environment\",\n              )\n            }\n            className=\"w-full rounded-lg bg-slate-800/80 py-1.5 text-[0.65rem] font-medium text-slate-300 ring-1 ring-slate-700 transition hover:bg-slate-700/80 md:text-[0.7rem]\"\n          >\n            {faceMode === \"environment\" ? \"Traseira\" : \"Frontal\"}\n          </button>\n        </div>\n      </aside>\n\n      {status === \"error\" && error && (\n        <p className=\"fixed bottom-4 left-4 right-28 max-w-md rounded-lg bg-rose-950/90 px-3 py-2 text-xs text-rose-200 ring-1 ring-rose-800 sm:right-36 md:right-44\">\n          {error}. Permita o acesso à câmera e use uma conexão segura (https).\n        </p>\n      )}\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}